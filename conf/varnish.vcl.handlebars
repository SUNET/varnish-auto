vcl 4.0;
import directors;

{{#each apps}}
{{#each backends}}
backend host_{{@index}}_{{@key}} {
    .host = "{{host}}";
    .port = "{{port}}";
    .probe = {
        .url = "/check/status.txt";
        .interval = 5s;
        .timeout = 1s;
        .window = 5;
        .threshold = 3;
    }
}
{{/each}}
{{/each}}

sub vcl_init {
    {{#each apps}}
    new {{@key}} = directors.round_robin();
    {{#each backends}}
    {{@key}}.add_backend(host_{{@index}}_{{@key}});
    {{/each}}
    {{/each}}
}

sub vcl_recv {
    set req.http.complete_url = "http://" + req.http.host + req.url;

    # redirects
    if (false) {}
    {{#each redirects}}
    else if (req.http.complete_url ~ "{{from}}") {
        {{#if internal}}
        set req.http.complete_url = regsub(req.http.complete_url, "{{from}}", "{{to}}");
        set req.http.host = regsub(req.http.complete_url, "^https?://([^/]+).*", "\1");
        set req.url = regsub(req.http.complete_url, "^https?://[^/]+(/.*)", "\1");
        {{else}}
        return (synth(301, regsub(req.http.complete_url, "{{from}}", "{{to}}")));
        {{/if}}
    }
    {{/each}}

    # apps
    if (false) {}
    {{#each apps}}
    else if (req.http.complete_url ~ "{{path}}") {
        set req.backend_hint = {{@key}}.backend();
    }
    {{/each}}
    unset req.http.cmplete_url;
}

sub vcl_synth {
    if (resp.status == 301) {
        set resp.http.Location = resp.reason;
        set resp.reason = "Moved Permanently";
        return(deliver);
    }
}
