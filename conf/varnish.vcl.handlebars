vcl 4.0;
import directors;

{{#each apps}}
{{#each ../backends}}
backend host_{{@index}}_{{../name}} {
    .host = "{{.}}";
    .port = "{{../port}}";
    .probe = {
        .url = "/check/status.txt";
        .interval = 5s;
        .timeout = 1s;
        .window = 5;
        .threshold = 3;
    }
}
{{/each}}
{{/each}}

sub vcl_init {
    {{#each apps}}
    new {{name}} = directors.round_robin();
    {{#each ../backends}}
    {{../name}}.add_backend(host_{{@index}}_{{../name}});
    {{/each}}
    {{/each}}
}

sub vcl_recv {
    {{#each apps}}
    if (req.url ~ "{{path}}") {
        set req.backend_hint = {{name}}.backend();
    }
    {{/each}}
}
