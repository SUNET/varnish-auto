vcl 4.0;
import directors;

{{#each apps}}
{{#each backends}}
backend host_{{@index}}_{{@key}} {
    .host = "{{host}}";
    .port = "{{port}}";
    .probe = {
        .url = "/check/status.txt";
        .interval = 5s;
        .timeout = 1s;
        .window = 5;
        .threshold = 3;
    }
}
{{/each}}
{{/each}}

sub vcl_init {
    {{#each apps}}
    new {{@key}} = directors.round_robin();
    {{#each backends}}
    {{@key}}.add_backend(host_{{@index}}_{{@key}});
    {{/each}}
    {{/each}}
}

sub vcl_recv {
    set req.http.complete_url = "http://" + req.http.host + req.url;
    {{#each apps}}
    if (req.http.complete_url ~ "{{path}}") {
        set req.backend_hint = {{@key}}.backend();
    }
    {{/each}}
    unset req.http.cmplete_url;
}
